{% extends 'main.html' %}
{% load static %}

{% block container-block %}
<script>
  let session_id = "{{request.session.session_id}}"
  let csrftoken = $('meta[name="csrf-token"]').attr('content');

  let button;
  let bNo;
  let cnt;

  $(document).on("click",".listLikeOn2",function(){
    alert("í´ë¦­");
    button = $(this)
    bNo = button.closest(".info_more").find(".item_bNo").val();
    cnt = button.next().next().text()
    $.ajax({
        headers: {"X-CSRFToken": csrftoken},  // CSRF í† í° ì„¤ì •
        url: '/foodBoard/Likes/',
        type: 'POST',
        dataType: 'json',  // JSON ì‘ë‹µ ì²˜ë¦¬
        data: {'id': session_id, 'bNo': bNo},
        success: function(data) {
            console.log(data);  // ì‘ë‹µ ë°ì´í„° ì¶œë ¥
            if (data.result == "remove") {
                alert("ì¢‹ì•„ìš”ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
                button.css({"display":"none"});  // í´ë¦­ëœ ë²„íŠ¼ì„ ìˆ¨ê¹€
                button.next().css({'display':"block"});  // ì´ì „ ìš”ì†Œë¥¼ í‘œì‹œ
                button.next().next().text(Number(cnt)-1);
            }
        },
        error: function() {
            alert('ì¢‹ì•„ìš”ë¥¼ ì‚­ì œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

  });
  });

  $(document).on("click",".listLikeOff2",function(){
    alert("í´ë¦­");
    if(session_id ==""){
      alert("ë¡œê·¸ì¸ì„ í•˜ì…”ì•¼ ì¢‹ì•„ìš”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
      location.href="/member/login/"
    }
    button = $(this)
    bNo = button.closest(".info_more").find(".item_bNo").val();
    cnt = button.next().text()
    $.ajax({
        headers: {"X-CSRFToken": csrftoken},  // CSRF í† í° ì„¤ì •
        url: '/foodBoard/Likes/',
        type: 'POST',
        dataType: 'json',  // JSON ì‘ë‹µ ì²˜ë¦¬
        data: {'id': session_id, 'bNo': bNo},
        success: function(data) {
            console.log(data);  // ì‘ë‹µ ë°ì´í„° ì¶œë ¥
            if (data.result == "add") {
                alert("ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤.");
                button.css({"display":"none"});  // í´ë¦­ëœ ë²„íŠ¼ì„ ìˆ¨ê¹€
                button.prev().css({'display':"block"});  // ì´ì „ ìš”ì†Œë¥¼ í‘œì‹œ
                button.next().text(Number(cnt)+1);
            }
        },
        error: function() {
            alert('ì¢‹ì•„ìš”ë¥¼ ì¶”ê°€í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
  });

  $(document).on("click", ".liststarOff2", function() {
    alert('í´ë¦­');
    if (session_id == "") {
        alert("ë¡œê·¸ì¸ì„ í•˜ì…”ì•¼ ì¦ê²¨ì°¾ê¸°ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
         location.href="/member/login/"
    }
    button = $(this);
    bNo = button.closest(".info_more").find(".item_bNo").val();
    
    $.ajax({
        headers: {"X-CSRFToken": csrftoken},  // CSRF í† í° ì„¤ì •
        url: '/foodBoard/Stars/',
        type: 'POST',
        dataType: 'json',  // JSON ì‘ë‹µ ì²˜ë¦¬
        data: {'id': session_id, 'bNo': bNo},
        success: function(data) {
            console.log(data);  // ì‘ë‹µ ë°ì´í„° ì¶œë ¥
            if (data.result == "1") {
                alert("ì¦ê²¨ì°¾ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                button.css({"display":"none"});  // í´ë¦­ëœ ë²„íŠ¼ì„ ìˆ¨ê¹€
                button.prev().css({"display":"block"}); 
            }
        },
        error: function() {
            alert('ì¦ê²¨ì°¾ê¸°ë¥¼ ë“±ë¡í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
  });

  $(document).on("click",".liststarOn2",function(){
    alert('í´ë¦­');
    button = $(this);
    bNo = button.closest(".info_more").find(".item_bNo").val();
    if(confirm("ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
      $.ajax({
        headers: {"X-CSRFToken": csrftoken},  // CSRF í† í° ì„¤ì •
        url: '/foodBoard/Stars/',
        type: 'POST',
        dataType: 'json',  // JSON ì‘ë‹µ ì²˜ë¦¬
        data: {'id': session_id, 'bNo': bNo},
        success: function(data) {
          console.log(data);  // ì‘ë‹µ ë°ì´í„° ì¶œë ¥
          if (data.result == "1") {
            alert("ì¦ê²¨ì°¾ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            button.css({"display":"none"});  // í´ë¦­ëœ ë²„íŠ¼ì„ ìˆ¨ê¹€
            button.next().css({"display":"block"}); 
          }
        },
        error: function() {
          alert('ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }
  });


  $(document).on("click", ".comment_list", function() {
    let button = $(this);
    let bNo = "{{flist.bNo}}";
    let rating = button.find(".comment_rating").val();
    let isEffective = button.hasClass('comment_effective');

    alert("í´ë¦­");
    console.log("Rating:", rating);
    console.log("bNo:", bNo);
    console.log("isEffective:", isEffective);

    let status = isEffective ? "0" : "1";  // ìƒíƒœì— ë”°ë¼ ì¶”ê°€ ë˜ëŠ” ì‚­ì œ ì„¤ì •

    $.ajax({
        headers: {"X-CSRFToken": csrftoken},  // CSRF í† í° ì„¤ì •
        url: '/foodBoard/Ratings/',
        type: 'POST',
        dataType: 'json',  // JSON ì‘ë‹µ ì²˜ë¦¬
        data: {'bNo': bNo, "rating": rating, "status": status},
        success: function(data) {
            if(data.result == "1") {
                alert(isEffective ? "ë°˜ì‘ì„ ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤." : "ë°˜ì‘ì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.");
                button.toggleClass('comment_effective');
                let count = Number(button.find(".comment_cnt").text().slice(0, -1));
                console.log("count : "+count)
                if (data.status == "1") {count +=1;}
                else if (data.status == "0") {count -=1;}
                button.find(".comment_cnt").text(count+"ëª…")
            }
        },
        error: function() {
            alert(isEffective ? 'ë°˜ì‘ì„ ì‚­ì œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' : 'ë°˜ì‘ì„ ì¶”ê°€í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
  });

  $(document).on("click",".listLoc2",function(){
    let form = $(this).siblings(".search-box");
    form.submit()
  });

  $(document).change(function(){
    let timeOption = $(".enterselect").val()
    if(timeOption=="1"){
      $(".select_wrap").css({"display":"inline"})
    } else{
      $(".select_wrap").css({"display":"none"})
    }
  })


  $(document).on("click", ".fTimeBtn", function() {
    let bNo = $(".item_bNo").val();
    let fPeople = $(".fPeople").val();
    let waitselect = $(".waitselect").val();
    let enterselect = $(".enterselect").val(); //ì§€ê¸ˆ,ì§ì ‘ì…ë ¥
    let hour = "";
    let minute = "";
  
     if(session_id ==""){
      alert("ë¡œê·¸ì¸ì„ í•˜ì…”ì•¼ ì…ë ¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
      location.href="/member/login/"
    }

    if (enterselect == "1") {
        hour = $(".enterhour").val();
        minute = $(".enterminute").val();
    }

    if (fPeople.length < 1) {
        alert("ì¸ì›ì„ ì…ë ¥í•˜ì„¸ìš”.");
        $(".fPeople").focus();
        return false;
    }

    if (enterselect == "1" && hour.length != 2) {
        alert("ì‹œëŠ” 2ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš”.");
        $(".enterhour").focus();
        return false;
    }

    if (enterselect == "1" && Number(hour) < 0 || Number(hour) > 13) {
        alert("ì‹œëŠ” 1ë¶€í„° 12ê¹Œì§€ì˜ ìˆ«ìë§Œ ì…ë ¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        $(".enterhour").focus();
        return false;
    }

    if (enterselect == "1" && minute.length != 2) {
        alert("ë¶„ì€ 2ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš”.");
        $(".enterminute").focus();
        return false;
    }

    if (enterselect == "1" && Number(minute) < 0 || Number(minute) > 60) {
        alert("ë¶„ì€ 0ë¶€í„° 59ê¹Œì§€ì˜ ìˆ«ìë§Œ ì…ë ¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        $(".enterminute").focus();
        return false;
    }
    fTimeForm.submit();
  });

    if ('{{ result }}'=="1") {
      bNo = '{{ bNo }}'; 
      alert('ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.href = `/foodBoard/foodView/${bNo}/`;
    };

    if ('{{ result }}'=="0") {
      bNo = '{{ bNo }}'; 
      alert('ì…ë ¥ì€ í•˜ë£¨ì— 1ë²ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      location.href = `/foodBoard/foodView/${bNo}/`;
    };

    if ('{{ result }}'=="2") {
      alert('ì…ë ¥ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      location.href = `/foodBoard/foodList/`;
    };


</script>
<main>
  <div id="foodboard1">  
    <div class="info_more">
      <input class="item_bNo" type="text" value="{{ flist.bNo }}" style="display: none;">
      <div class="info_img">
        {% if flist.bFile1 %}
        <img src= "{{flist.bFile1.url}}">
        {% endif %}
        {% if flist.bFile2 %}
        <img src= "{{flist.bFile2.url}}">
        {% endif %}
        {% if flist.bFile3 %}
        <img src= "{{flist.bFile3.url}}">{% endif %}
      </div>
      <br>
      <div class="info_text">
        <div class="info_wrap">
          <div class="bottom_slide">
            <strong>{{flist.bTitle}}
              <a href="/foodBoard/foodRes/{{flist.bNo}}/">
                <ion-icon name="chevron-forward-outline" class="moreIcon"></ion-icon>
              </a>
            </strong>
            <span class="info_waiting">í‰ê·  ì›¨ì´íŒ… : 
              <strong class="info_time">{{TimeAvg}}</strong>
              ë¶„</span>
            <p>{{flist.bLocation}}</p>
          </div>
        </div>
        <div class="button_wrap">
          <div class="reservation">
            <a href="/foodBoard/foodRes/{{flist.bNo}}/">
            <ion-icon name="calendar-number-outline" style="width:30px; height:30px;"></ion-icon>
            <p>ì˜ˆì•½í•˜ê¸°</p>
          </a>
          </div>
        </div>
      </div>
      {% if flist.is_liked %}
      <button class="listLikeOn2" style="display:block"></button>
      <button class="listLikeOff2" style="display:none"></button>
      {% else %}
      <button class="listLikeOn2" style="display:none"></button>
      <button class="listLikeOff2" style="display:block"></button>
      {% endif %}
              <span class="LikeCnt2">{{flist.like_count}}</span>
              <button class="listLoc2"></button>
              <form class="search-box" action="/map/success/" method="post" id="search-form" style="display:none">
              {% csrf_token %}
                <input class="search-txt" type="text" name="search_word" value="{{flist.bLocation}}" style="display:none">
              </form>
              {% if flist.star %}
              <button class="liststarOn2" style="display:block"></button>
              <button class="liststarOff2" style="display:none"></button>
              {% else %}
              <button class="liststarOn2" style="display:none"></button>
              <button class="liststarOff2" style="display:block"></button>
              {% endif %}
      <br/>
      <div class="bottom_content">
            <strong>{{flist.bSubtitle}}</strong>
            <p>{{flist.bContent|safe}}</p>
            </div>
          </div>
          <div class="fTimeflex">
            <form id="fTimeForm" name='fTimeForm' method="POST">
              {% csrf_token %}
              <h4 class="fTimeTitle">í˜¹ì‹œ ì´ ì‹ë‹¹ì— ë°©ë¬¸í•˜ì…¨ë‚˜ìš”?<br/> ë‹¹ì‹ ì˜ ì›¨ì´íŒ… ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</h4>
              <br/>
              <input type='hidden' name='bNo' value="{{flist.bNo}}">
              <label>ì¸ì› : </label>
              <input type='text' name='fPeople' class='fPeople' placeholder="3" maxlength="2">
            <span>ëª…</span><br/>
            <label>ì›¨ì´íŒ… ì‹œê°„ : </label>
            <select class="waitselect"name='waitselect'>
              <option value='0'>ë°”ë¡œ ì…ì¥</option>
              <option value='10'>10ë¶„ ì´ë‚´</option>
              <option value='30'>30ë¶„ ì´ë‚´</option>
              <option value='45'>30ë¶„~1ì‹œê°„</option>
              <option value='60'>1ì‹œê°„ ì´ìƒ</option>
              <option value='120'>2ì‹œê°„ ì´ìƒ</option>
            </select>
            <br/>
            <label>ì…ì¥ ì‹œê°„ : </label>
            <select class="enterselect" name="enterselect">
              <option value="0">ì§€ê¸ˆ</option>
              <option value="1">ì§ì ‘ì…ë ¥</option>
            </select>
            <div class="select_wrap" style="display:none">  
              
              <select class="timeselect" name="timeselect">
                <option value="AM">ì˜¤ì „</option>
                <option value="PM">ì˜¤í›„</option>
              </select>
              <input type='text' name='hour' class="enterhour" placeholder="12" maxlength="2">
              <label>ì‹œ</label>
              <input type='text' name='minute' class="enterminute" placeholder="00" maxlength="2">
              <label>ë¶„</label>
            </select>
          </div>
          <br/>
          <button type='button' class="fTimeBtn">ì…ë ¥í•˜ê¸°</button>
        </form>
        <div class='fTimeStat'>
          <h4 class='fTimeStatTitle'>ì›¨ì´íŒ… ì‹œê°„ í†µê³„ ({{now}} ê¸°ì¤€)</h4>
          <div style="width: 650px; height:400px;"><canvas id="TimeStat"></canvas></div>
    {% block script %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (async function() {
            // JSON ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ JavaScript ê°ì²´ë¡œ ë³€í™˜
            const labels = JSON.parse('{{ labels|escapejs }}');
            const times = JSON.parse('{{ times|escapejs }}');
            const counts = JSON.parse('{{ counts|escapejs }}');
            
            // Chart.js ì‚¬ìš©í•˜ì—¬ ê·¸ë˜í”„ ìƒì„±
            new Chart(
                document.getElementById('TimeStat'),
                {
                    type: 'line',
                    data: {
                        labels: labels,  // ì‹œê°„ëŒ€ ë¼ë²¨ ì„¤ì •
                        datasets: [
                            {
                                label: 'í‰ê·  ëŒ€ê¸°ì‹œê°„',
                                data: times,  // í‰ê·  ëŒ€ê¸° ì‹œê°„ ë°ì´í„°
                                borderColor: 'rgba(75, 192, 192, 1)',
                            },
                            {
                                label: 'ì‘ë‹µ ìˆ˜',
                                data: counts,  // ë°ì´í„° ê°œìˆ˜
                                borderColor: 'rgba(255, 99, 132, 1)',
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'ì‹œê°„ëŒ€ (00ì‹œ)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ìˆ˜ì¹˜'
                                }
                            }
                        }
                    }
                }
            );
        })();
    </script>
    {% endblock %}
        </div>
      </div>
        <button class="cancelBtn1" onclick="location.href='/foodBoard/foodList/'">ëª©ë¡ìœ¼ë¡œ</button>
        <br/>
        <br/>
        <hr class="comment_seperator"></hr>
        <br/>
          <div class="comment_div">  
            <button type='button' class="comment_list {% if '1' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content" ><span class="comment_icon">ğŸ˜‹</span>ìŒì‹ì´ ë§›ìˆì–´ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.0}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="1">
            </button>
            <button type='button' class="comment_list  {% if '2' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">ğŸš</span>ì–‘ì´ ë§ì•„ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.1}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="2">
            </button>
            <button type='button' class="comment_list {% if '3' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">ğŸ‘€</span>ë§¤ì¥ì´ ë„“ì–´ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.2}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="3">
            </button>
            <button type='button' class="comment_list {% if '4' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">ğŸ’¸</span>ê°€ì„±ë¹„ê°€ ì¢‹ì•„ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.3}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="4">
            </button>
            <button type='button' class="comment_list {% if '5' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">ğŸ’–</span>ì¹œì ˆí•´ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.4}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="5">
            </button>
            <button type='button' class="comment_list {% if '6' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">ğŸŒ±</span>ì¬ë£Œê°€ ì‹ ì„ í•´ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.5}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="6">
            </button>
            <button type='button' class="comment_list {% if '7' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">â›°ï¸</span>ë·°ê°€ ì¢‹ì•„ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.6}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="7">
            </button>
            <button type='button' class="comment_list {% if '8' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">âœ¨</span>ë§¤ì¥ì´ ì²­ê²°í•´ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.7}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="8">
            </button>
            <button type='button' class="comment_list {% if '9' in rate_list %}comment_effective{% endif %}">
              <h4 class="comment_content"><span class="comment_icon">ğŸš˜</span>ì£¼ì°¨ì¥ì´ ë„“ì–´ìš”</h4>              
              <h4 class="comment_cnt">{{rate_count.8}}ëª…</h4>
              <input class ="comment_rating" type='hidden' value="9">
            </button>
          </div>
        </div>
      </div>
    </main>
    {% endblock container-block %}
    